# Redis持久化策略

## 分类

Redis有两种持久化机制——快照与AOF日志，快照是一次全量备份，AOF日志是持续增量备份。快照把内存数据二进制序列化存储，AOF是内存数据修改的指令记录文本，重启将AOF指令重新执行，时间花费很大。

## 快照原理

Redis是单线程程序，这个线程负责处理所有客户端套接字的操作请求，内存快照会要求IO操作，文件的IO操作不能使用多路复用API，所以保存快照会拖慢服务器的性能。同时快照保存时内存结构、内容不断变化，这也是持久化需要考虑的问题。

### fork和COW

持久化时调用glibc的函数fork产生一个子进程，与父进程共享内存的代码段和数据段。这时使用操作系统的COW机制进行数据段页面的分离，当父进程要对其中的页面进行修改时，会将共享的页面复制一份进行修改。

## AOF原理

AOF日志存储Redis服务器的顺序指令。Redis实例收到客户端指令后，进行参数校验并进行处理，如果没问题，就立刻将该指令存储到AOF日志中。

AOF会随着运行时间的增长而增多，重放日志也会非常耗时，所以需要进行AOF日志瘦身。Redis提供了bgrewriteaof指令，原理是开辟一个子进程对内存进行遍历转换成一系列的Redis操作指令，序列化到一个新的AOF日志文件中，序列化完毕后再将操作期间的AOF日志追加到新的AOF日志文件中。

### fsync

程序对AOF日志文件进行写操作，实际是将内容写到了内核为文件描述符分配的一个内存缓存中，然后内核会异步将脏数据刷回到磁盘。所以机器宕机时，日志还没完全刷到磁盘中，这就意味着日志的丢失。

Linux的glibc提供了fsync函数，可以将指定文件的内容强制从内核缓存刷到磁盘，但是速度很慢，所以一般是隔1s进行一次fsync操作。

## 混合持久化

Redis 4.0开始支持的混合持久化，将rdb文件的内容和增量的AOF日志存在一起，Redis重启时，先初始化rdb文件内容，再重放AOF文件。

