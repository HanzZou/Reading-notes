# Redis数据结构与对象

## SDS(simple dynamic string)，简单动态字符串

### 与C中字符串结构的区别
1. SDS保存了结构中已使用和未使用的字符个数，在求长度操作时只需O(1)时间复杂度。
2. 可避免C中字符串可能会出现的缓冲区溢出现象，原因是在字符串后拼接字符串时会进行长度的校验，超出准备好的未使用空间时会进行内存重分配。
3. 通过算法减少字符串的内存重分配次数，核心是预留空间。Redis的设计避免字符串内存重分配成为性能瓶颈。两种优化策略：
	1. 空间预分配
		重分配后字符数组长度不超过1MB时预留已使用长度len，超过后预留1MB。
	2. 惰性空间释放
		字符串缩短时保留未使用空间，不会发生内存重分配。SDS也提供了相应的API，有需要时可释放未使用空间。
4. SDS具有二进制安全性，SDS API会以处理二进制的方式处理buf数组。
5. SDS可以使用一部分\<string.h\>库中的函数

## 链表

当列表键中包含了数量较多的元素，或列表中包含的元素是比较长的字符串时，底层实现使用链表。

Redis的链表实现是双向的，无环（表头prev指针和表尾的next指针都指向NULL），带表头指针和表尾指针（获取表尾的复杂度为O(1)），带长度计数器（获取长度复杂度为O(1)），不限定存储值的类型。

## 字典

Redis的数据库使用字典作为底层实现，也是哈希键的底层实现之一。

哈希表底层：哈希表数组，哈希表大小size，掩码（size-1），已有节点数量used；
哈希表节点dictEntry结构组成：键key指针，值可以是指针、uint64\_t，int64\_t，next指针指向下一个节点。

字典结构：类型特定函数type，私有数据privdata，哈希表，是否在rehash中的标记trehashidx；

- type属性是一个指向dictType结构的指针，这个结构中包含一系列特定函数，包括计算哈希值、复制键、复制值、对比键、销毁键、销毁值。
- privdata保存了需要传给dictType结构中函数的可选参数。
- 哈希表数组有两项，一项用于存储字典数据，另一个只有在rehash时才使用。
